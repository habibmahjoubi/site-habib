<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Outils Data & Visualisation | Habib MAHJOUBI</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <style>
    /* --- HERO + CARDS OUTILS --- */
    .tools-hero {
      display: flex; align-items: center; gap: 34px;
      border-radius: 24px; margin: 34px 0 26px 0;
      background: linear-gradient(110deg,#eaf3fa 55%,#c9eef6 100%);
      box-shadow: 0 2px 15px #b7e7ff22;
      padding: 28px 10px 26px 30px;
      position: relative;
    }
    .tools-hero-logo {
      width:82px;height:82px;border-radius:16px;background:#eaf3fa2e;
      display:flex;align-items:center;justify-content:center;font-size:3em;color:#11bba8;box-shadow:0 2px 10px #11bba81e;
    }
    .tools-hero-content h1 { font-size: 2em; margin: 0; color: #11bba8; font-weight: bold;}
    .tools-hero-content p { margin: 7px 0 2px 0; color: #127782;font-size: 1.07em;font-weight: 500;}
    .tools-board {margin: 34px 0 24px 0; display: flex; gap: 30px; flex-wrap: wrap; justify-content: center;}
    .tools-card {background:#f7fafc; box-shadow:0 2px 12px #b7e7ff11;
      border-radius:13px;padding:17px 14px 13px 14px; max-width:208px; min-width:110px;
      display:flex;flex-direction:column; align-items:center;justify-content:center;
      border:1.5px solid #eaf3fa;transition:box-shadow .16s,transform .13s;
      text-align:center; margin-bottom:8px; position:relative;}
    .tools-card i, .tools-card img {font-size:2.1em;color:#11bba8;margin-bottom:7px;}
    .tools-card-cta {
      background:#11bba8;color:#fff;border:none;border-radius:7px;
      padding:6px 15px;margin-top:11px;cursor:pointer;font-weight:600;font-size:.98em;
      transition:background .13s;
    }
    .tools-card-cta:hover{background:#127782;}
    .tools-card-title {font-size:1em;font-weight:700;color:#167a8c;}
    .tools-card-desc {font-size:.97em;color:#195b80;opacity:.8;margin-top:4px;}
    .tools-card:hover {box-shadow:0 4px 16px #11bba842;transform:scale(1.035);}
    @media(max-width:800px){.tools-board{gap:16px;}}
    @media(max-width:600px){
      .tools-hero{flex-direction:column;gap:10px;padding:16px 3vw;}
      .tools-board{flex-direction:column;align-items:center;}
      .tools-card{max-width:97vw;}
    }
    /* --- MODALE DATAVIZ + INTERACTIVE --- */
    .tools-viz-modal {
      position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(31,52,66,0.18);
      z-index:2000;display:flex;align-items:center;justify-content:center; animation: fadeIn .33s;
    }
    @keyframes fadeIn{0%{opacity:0;}100%{opacity:1;}}
    .tools-viz-modal-content {
      width: min(96vw, 650px);
      background: #fff; border-radius:15px; box-shadow:0 6px 42px #11bba83e;
      padding: 29px 25px 22px 25px; position:relative;
      max-height:93vh; overflow-y:auto;
    }
    .tools-viz-close {
      position:absolute;top:16px;right:14px;background:none;border:none;font-size:1.8em;cursor:pointer;color:#11bba8;
      transition:color .15s;}
    .tools-viz-close:hover { color:#db4730; }
    #dataviz-plot {margin-top:20px;min-height:140px;}
    /* ------ DATAVIZ TOOL CSS -------- */
    .dataviz-tool { background: #eaf3fa; border-radius: 14px; box-shadow: 0 2px 12px #b7e7ff2a; max-width: 650px; padding: 23px 20px 27px 20px; margin: 0 auto 0 auto; border: 1.3px solid #bcdfeb42;}
    .dataviz-label { font-weight: 700; color: #127782; margin-bottom: 8px; display: inline-block; letter-spacing: .03em; font-size: 1.02em;}
    #datamatrix { width: 100%; max-width: 100%; min-width: 0; font-family: 'Fira Mono', 'Consolas', monospace; font-size: 1em; border-radius: 8px; border: 1.5px solid #b4d5e1; padding: 8px 12px; background: #fff; color: #145b6b; margin: 12px 0 13px 0; box-sizing: border-box; resize: vertical; transition: box-shadow .13s, border .13s;}
    #datamatrix:focus { border-color: #11bba8; box-shadow: 0 1px 9px #11bba824; }
    input[type="file"]#csv-file { margin-bottom: 13px; margin-top: 7px; background: #f8fcff; padding: 7px; border-radius: 6px; border: 1.2px solid #b4d5e1; color: #145b6b;}
    .dataviz-controls { margin:12px 0 15px 0; display:flex;align-items:center;gap:17px;flex-wrap:wrap;}
    .dataviz-controls select, .dataviz-controls input[type="color"] { padding: 6px 8px; border-radius: 6px; border: 1.2px solid #b4d5e1; font-size: 1em; background: #fff; min-width: 45px; margin-right: 3px; cursor: pointer; transition: border .14s;}
    .dataviz-controls input[type="color"]:hover, .dataviz-controls select:focus { border-color: #11bba8; }
    .dataviz-btn { background: #11bba8; color: #fff; font-weight: 500; border: none; border-radius: 7px; font-size: 1em; padding: 7px 10px; cursor: pointer; transition: background .13s,transform .13s; box-shadow: 0 1.5px 6px #11bba81a; margin-left: 6px;}
    .dataviz-btn:hover { background: #127782; transform:scale(1.08); }
    .dataviz-plot { margin-top: 22px; min-height: 190px; border-radius: 9px; background: #f7fafc; box-shadow: 0 1.5px 8px #b7e7ff14; padding: 6px 3px 5px 3px;}
    #dataviz-metrics { margin: 14px 0 0 0; font-size: 0.98em; background:#fbfff8; border-radius:7px; box-shadow:0 1.5px 5px #b7e7ff19; padding:8px 10px 6px 10px; }
    #dataviz-metrics table { border-collapse: collapse; margin:auto; min-width: 88%;}
    #dataviz-metrics th, #dataviz-metrics td { border: 1px solid #eaf3fa; padding: 6px 9px; text-align: center; }
    #dataviz-metrics th { background: #eaf3fa; color: #127782; font-weight: 700;}
    #dataviz-metrics td { background: #fff; }
    @media (max-width:700px){
      .dataviz-tool{max-width:99vw;padding:13px 2vw 18px 2vw;}
      .dataviz-controls{flex-direction:column;align-items:flex-start;gap:10px;}
      #datamatrix{font-size:0.98em;}
      .tools-viz-modal-content{padding:7vw 2vw;}
    }
  </style>
</head>
<body>
  <canvas id="bg-management"></canvas>
  <main class="page-details">
    <a href="index.html">&larr; Retour</a>
    <div class="tools-hero">
      <div class="tools-hero-logo">
        <i class="fas fa-tools"></i>
      </div>
      <div class="tools-hero-content">
        <h1>Outils Data & Visualisation</h1>
        <p>Scripts, visualisateurs et adaptations open-source pour explorer, analyser et représenter vos données scientifiques ou métiers.</p>
      </div>
    </div>
    <div class="tools-board">
      <div class="tools-card">
        <i class="fas fa-chart-bar"></i>
        <div class="tools-card-title">Heatmap Visualizer</div>
        <div class="tools-card-desc">
          Générateur interactif de heatmap (bio/data) pour fichiers ou matrices.
        </div>
        <button class="tools-card-cta" id="btnShowViz">Essayer</button>
      </div>
      <div class="tools-card">
        <i class="fas fa-dna"></i>
        <div class="tools-card-title">Gene Cluster Plot</div>
        <div class="tools-card-desc">
          Clustering de gènes ou d’échantillons avec coloration dynamique (Python/R/JS).
        </div>
        <button class="tools-card-cta" onclick="openGeneClusterModal()">Demo</button>
      </div>
      <div class="tools-card">
        <i class="fas fa-file-csv"></i>
        <div class="tools-card-title">Parseur CSV</div>
        <div class="tools-card-desc">
          Nettoie et convertit vos fichiers CSV pour des imports directs en R ou Pandas.
        </div>
        <button class="tools-card-cta" onclick="openparseurModal()">Utiliser</button>
      </div>
      <div class="tools-card">
        <i class="fas fa-project-diagram"></i>
        <div class="tools-card-title">Diagramme interactif</div>
        <div class="tools-card-desc">
          Créez vos propres diagrammes et graphes de workflow (glisser/déposer).
        </div>
        <button class="tools-card-cta" onclick="opendiagrammeModal()">Essayer</button>
      </div>
    </div>
    <footer class="logos-footer" style="margin-top:32px;">
      <div class="logos-orga">
        <img src="images/python.png" alt="Logo Python">
        <img src="images/rlogo.png" alt="Logo R">
        <img src="images/plotly.png" alt="Logo Plotly">
        <img src="images/js.png" alt="Logo JS">
      </div>
    </footer>

    <!-- Modal Gene Cluster Plot -->
    <div id="geneClusterModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeGeneClusterModal()">&times;</span>
        <h2>Gene Clustering</h2>
        <p>Bienvenue dans la démo de clustering de gènes ! (En cours de construction)</p>
      </div>
    </div>
    <!-- Modal Parseur csv -->
    <div id="parseurModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeparseurModal()">&times;</span>
        <h2>Parseur CSV</h2>
        <p>Bienvenue dans l'outil' Parseur CSV ! (En cours de construction)</p>
      </div>
    </div>
    <!-- Modal Diagramme interactif -->
    <div id="diagrammeModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closediagrammeModal()">&times;</span>
        <h2>Diagramme interactif</h2>
        <p>Bienvenue dans l'outil Diagramme interactif ! (En cours de construction)</p>
      </div>
    </div>

    <!-- Modal outils heat map  visualisar-->
    <div id="tools-viz-modal" class="tools-viz-modal" style="display:none;">
      <div class="tools-viz-modal-content">
        <button class="tools-viz-close" onclick="closeToolsViz()">&times;</button>
        <h3>Visualisation interactive de vos données</h3>
        <div class="dataviz-tool">
          <form id="dataviz-form" onsubmit="return false;">
            <label class="dataviz-label">Titre du graphique :</label>
            <input id="viz-title" type="text" placeholder="Titre du graphique" style="margin-bottom:6px;">
            <div class="dataviz-section">
              <strong>Mise en forme Titre:</strong>
              <label>Taille:</label>
              <input type="number" id="title-size" min="10" max="45" value="26" style="width:55px">
              <label>Police:</label>
              <select id="title-font">
                <option>Arial</option><option>Verdana</option><option>Helvetica</option><option>Georgia</option><option>Trebuchet MS</option>
              </select>
              <label>Couleur:</label>
              <input type="color" id="title-color" value="#1f77b4">
            </div>
            <label class="dataviz-label">Axe X :</label>
            <input id="viz-xaxis" type="text" placeholder="ex : Jours, min, type de stress..." style="margin-bottom:6px;">
            <label class="dataviz-label">Axe Y :</label>
            <input id="viz-yaxis" type="text" placeholder="ex : Gènes" style="margin-bottom:12px;">
            <div class="dataviz-section">
              <strong>Mise en forme axes:</strong>
              <label>X: taille</label>
              <input type="number" id="xaxis-fontsize" min="8" max="30" value="17" style="width:43px">
              <label>police</label>
              <select id="xaxis-font">
                <option>Arial</option><option>Verdana</option><option>Georgia</option>
              </select>
              <label>couleur</label>
              <input type="color" id="xaxis-color" value="#333333">
              <label>Y: taille</label>
              <input type="number" id="yaxis-fontsize" min="8" max="30" value="17" style="width:43px">
              <label>police</label>
              <select id="yaxis-font">
                <option>Arial</option><option>Verdana</option><option>Georgia</option>
              </select>
              <label>couleur</label>
              <input type="color" id="yaxis-color" value="#333333">
            </div>
            <div class="dataviz-section">
              <strong>Paramètres échelles :</strong>
              <label>Y min:</label>
              <input type="number" id="y-min" placeholder="auto" style="width:70px">
              <label>Y max:</label>
              <input type="number" id="y-max" placeholder="auto" style="width:70px">
              <label>X min:</label>
              <input type="text" id="x-min" placeholder="auto" style="width:70px">
              <label>X max:</label>
              <input type="text" id="x-max" placeholder="auto" style="width:70px">
            </div>
            <div class="dataviz-section">
              <label for="legend-title" style="font-weight:bold;">Titre de la légende :</label>
              <input type="text" id="legend-title" placeholder="Type de stress" style="width:180px;">
            </div>
            <div class="dataviz-section">
              <input type="checkbox" id="show-grid" checked>
              <label for="show-grid">Afficher grille</label>
              <input type="checkbox" id="show-legend" checked>
              <label for="show-legend">Afficher légende</label>
              <input type="checkbox" id="invert-yaxis">
              <label for="invert-yaxis">Inverser Y</label>
            </div>
            <div class="dataviz-section" id="box-colors-section" style="display:none;">
              <strong>Couleurs des boxes :</strong>
              <input type="text" id="box-colors" placeholder="#11bba8, #339933, #cc5500, #ccdd00" style="width:260px;">
              <span style="font-size:0.93em;">(Mettre une couleur hex pour chaque box, séparées par , )</span>
            </div>
            <div class="dataviz-section">
              <label>Largeur (px):</label>
              <input type="number" id="fig-width" min="200" max="2400" value="650" style="width:65px;">
              <label>Hauteur (px):</label>
              <input type="number" id="fig-height" min="180" max="1600" value="420" style="width:65px;">
            </div>
            <label class="dataviz-label">Matrice/CSV (copier depuis Excel possible) :</label>
            <textarea id="datamatrix" rows="7" placeholder="J1 J3 J5 J7 J9&#10;gene1 1 1 1 1 1&#10;gene2 0.702 0.610 0.679 0.513 0.527&#10;..."></textarea>
            <input type="file" id="csv-file" accept=".csv,text/csv" style="margin:9px 0 5px 0;" onchange="loadCSV(this)">
            <div class="dataviz-controls">
              <span>Couleur min :</span>
              <input type="color" id="color-min" value="#ffffe0">
              <span>Couleur max :</span>
              <input type="color" id="color-max" value="#11bba8">
              <span>Type :</span>
              <select id="viz-type">
                <option value="heatmap">Heatmap</option>
                <option value="bar">Barres</option>
                <option value="scatter">Nuage (scatter)</option>
                <option value="line">Linéaire</option>
                <option value="box">Boxplot</option>
                <option value="hist">Histogramme</option>
              </select>
              <button onclick="drawViz()" class="dataviz-btn">Visualiser</button>
            </div>
          </form>
          <div id="dataviz-plot" class="dataviz-plot"></div>
          <button class="dataviz-btn" id="btn-download" style="display:none;margin-top:12px;" onclick="savePlot()">Télécharger le graphique</button>
        </div>
      </div>
    </div>
    <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
    <script>
    window.legendCustomNames = [];

    function parseBioMatrix(txt) {
      txt = txt.replace(/(\d),(\d)/g, '$1.$2');
      let rows = txt.trim().split(/\r?\n/).filter(Boolean);
      let sep = /[ \t,;]+/;
      let head = rows[0].split(sep);
      let x = head.slice(1);
      let y = [], z = [];
      for (let i = 1; i < rows.length; i++) {
        let parts = rows[i].split(sep);
        if (parts.length < 2) continue;
        y.push(parts[0]);
        z.push(parts.slice(1).map(v => Number(v)));
      }
      return { x, y, z };
    }

    function loadCSV(input) {
      if (!input.files.length) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('datamatrix').value = e.target.result;
        updateLegendNamesInputs();
      };
      reader.readAsText(input.files[0]);
    }

    function updateLegendNamesInputs() {
      let txt = document.getElementById('datamatrix').value.trim();
      if (!txt) return;
      let rows = txt.trim().split(/\r?\n/).filter(Boolean);
      let sep = /[ \t,;]+/;
      let type = document.getElementById('viz-type').value;
      let legendSection = document.getElementById('legend-names-section');
      let legendInputsDiv = document.getElementById('legend-names-inputs');
      legendInputsDiv.innerHTML = '';
      // On affiche les noms de séries seulement sur bar, line, scatter, box
      if (["bar", "line", "scatter", "box"].includes(type)) {
        let yLabels = [];
        for (let i = 1; i < rows.length; i++) {
          let parts = rows[i].split(sep);
          if (parts.length<2) continue;
          yLabels.push(parts[0]);
        }
        if (yLabels.length == 0) {
          legendSection.style.display = "none";
          return;
        }
        window.legendCustomNames = yLabels.slice();
        yLabels.forEach((lab, i) => {
          let inp = document.createElement('input');
          inp.type = "text";
          inp.value = lab;
          inp.setAttribute("data-index", i);
          inp.style.margin = "3px 11px 3px 0";
          inp.style.width = "100px";
          inp.oninput = function() {
            legendCustomNames[i] = this.value;
            drawViz();
          };
          legendInputsDiv.appendChild(document.createTextNode((type==="box"?"Catégorie ":"Série ")+(i+1)+": "));
          legendInputsDiv.appendChild(inp);
        });
        legendSection.style.display = "";
      } else {
        legendSection.style.display = "none";
        window.legendCustomNames = [];
      }
    }

    // Coloration dynamique pour boxplot seulement
    function showBoxColorsIfNeeded() {
      document.getElementById('box-colors-section').style.display =
        document.getElementById('viz-type').value === "box" ? "" : "none";
    }

    // Met à jour les inputs dynamiques au changement de type ou data
    document.getElementById('datamatrix').addEventListener('input', updateLegendNamesInputs);
    document.getElementById('viz-type').addEventListener('change', function() {
      updateLegendNamesInputs();
      showBoxColorsIfNeeded();
    });

    function drawViz() {
      let txt = document.getElementById('datamatrix').value;
      let type = document.getElementById('viz-type').value;
      let title = document.getElementById("viz-title").value.trim();
      let xaxis = document.getElementById("viz-xaxis").value.trim();
      let yaxis = document.getElementById("viz-yaxis").value.trim();
      let plotDiv = document.getElementById('dataviz-plot');
      if(!txt.trim()) return false;
      let {x, y, z} = parseBioMatrix(txt);
      if(x.length === 0 || y.length === 0) return false;
      // options avancées
      let legendTitle = document.getElementById('legend-title').value.trim();
      let titleFont = document.getElementById('title-font').value;
      let titleSize = parseInt(document.getElementById('title-size').value) || 26;
      let titleColor = document.getElementById('title-color').value;
      let xFont = document.getElementById('xaxis-font').value;
      let xFontSize = parseInt(document.getElementById('xaxis-fontsize').value) || 17;
      let xColor = document.getElementById('xaxis-color').value;
      let yFont = document.getElementById('yaxis-font').value;
      let yFontSize = parseInt(document.getElementById('yaxis-fontsize').value) || 17;
      let yColor = document.getElementById('yaxis-color').value;
      let ymin = document.getElementById('y-min').value.trim();
      let ymax = document.getElementById('y-max').value.trim();
      let xmin = document.getElementById('x-min').value.trim();
      let xmax = document.getElementById('x-max').value.trim();
      let showGrid = document.getElementById('show-grid').checked;
      let showLegend = document.getElementById('show-legend').checked;
      let invertY = document.getElementById('invert-yaxis').checked;
      let figWidth = parseInt(document.getElementById('fig-width').value)||650;
      let figHeight = parseInt(document.getElementById('fig-height').value)||420;
      let cmin = document.getElementById('color-min').value;
      let cmax = document.getElementById('color-max').value;
      const couleurs = [
        "#1f77b4", "#ff7f0e", "#2ca02c", "#d62728", "#9467bd",
        "#8c564b", "#e377c2", "#7f7f7f", "#bcbd22", "#17becf"
      ];
      let data = [], layout = {};
      // Utilise les légendes custom si présentes
      let customNames = window.legendCustomNames || [];

      if(type === "heatmap") {
        let baseHeight = 300;
        let rowHeight = Math.max(18, 18 - Math.max(0, y.length - 12));
        let newHeight = Math.max(baseHeight, y.length * rowHeight + 80, figHeight);
        data = [{
          z: z, x: x, y: y, type:'heatmap',
          colorscale: [[0, cmin], [1, cmax]],
          colorbar: { title: yaxis || "Valeur" },
          zmin: Math.min(...z.flat()),
          zmax: Math.max(...z.flat()),
          name: title || "Valeurs",
          showscale: showLegend
        }];
        layout = {
          margin: { t: 55, r: 40, l: 90, b: 60 },
          height: newHeight, width: figWidth,
          yaxis: { automargin: true, showgrid: !!showGrid },
          xaxis: { showgrid: !!showGrid },
          hovermode: 'closest',
          showlegend: showLegend
        };
      }
      else if(type === "bar" || type==="line") {
        if(z.length==1) {
          data = [{
            x: x,
            y: z[0],
            type: type==="bar" ? "bar" : "scatter",
            mode: type==="line" ? "lines+markers" : undefined,
            marker: {color: couleurs[0]},
            name: customNames[0] || y[0] || "Données"
          }];
        } else {
          data = y.map((gene,i)=>({
            x: x,
            y: z[i],
            type:type==="bar"?"bar":"scatter",
            mode:type==="line"?"lines+markers":undefined,
            name: customNames[i] || gene || ("Série "+(i+1)),
            marker: {color: couleurs[i % couleurs.length]}
          }));
        }
        let allY = z.flat().filter(n=>!isNaN(n));
        let minY = Math.min(...allY);
        let maxY = Math.max(...allY);
        let padding = (maxY - minY) * 0.1;
        if (!isFinite(padding) || padding === 0) padding = 0.5;
        layout = {
          margin:{t:55,r:35,l:70,b:60},
          height: figHeight, width: figWidth,
          yaxis: {
            automargin: true,
            range: [minY-padding, maxY+padding],
            showgrid: !!showGrid
          },
          xaxis: { showgrid: !!showGrid },
          barmode: 'group',
          showlegend: showLegend
        };
        if (ymin !== "") layout.yaxis.range[0] = +ymin;
        if (ymax !== "") layout.yaxis.range[1] = +ymax;
        if (xmin !== "") { layout.xaxis.range = layout.xaxis.range || []; layout.xaxis.range[0] = isNaN(xmin)?xmin:+xmin; }
        if (xmax !== "") { layout.xaxis.range = layout.xaxis.range || []; layout.xaxis.range[1] = isNaN(xmax)?xmax:+xmax; }
      }
      else if(type === "scatter") {
        let allY = z.flat().filter(n=>!isNaN(n));
        let minY = Math.min(...allY);
        let maxY = Math.max(...allY);
        let padding = (maxY - minY) * 0.1;
        if (!isFinite(padding) || padding === 0) padding = 0.5;
        if(y.length === 1) {
          let scatterX = x.map(xx => Number(xx));
          let scatterY = z[0];
          data = [{
            x: scatterX,
            y: scatterY,
            type: "scatter",
            mode: "markers",
            marker: {color: "black", size: 7},
            showlegend: showLegend,
            name: customNames[0] || y[0] || "Série"
          }];
        } else {
          data = y.map((gene, i) => ({
            x: x,
            y: z[i],
            type: "scatter",
            mode: "markers",
            marker: {color: couleurs[i%couleurs.length], size: 7},
            name: customNames[i] || gene || ("Série "+(i+1)),
            showlegend: showLegend
          }));
        }
        layout = {
          margin: {t:55, r:35, l:65, b:60},
          height: figHeight, width: figWidth,
          yaxis: {
            automargin: true,
            range: [minY-padding, maxY+padding],
            showgrid: !!showGrid
          },
          xaxis: { showgrid: !!showGrid },
          showlegend: showLegend
        };
        if (ymin !== "") layout.yaxis.range[0] = +ymin;
        if (ymax !== "") layout.yaxis.range[1] = +ymax;
        if (xmin !== "") { layout.xaxis.range = layout.xaxis.range || []; layout.xaxis.range[0] = isNaN(xmin)?xmin:+xmin; }
        if (xmax !== "") { layout.xaxis.range = layout.xaxis.range || []; layout.xaxis.range[1] = isNaN(xmax)?xmax:+xmax; }
      }
      else if(type==="box") {
        data = [];
        let userBoxColors = (document.getElementById('box-colors').value||'').split(',').map(c=>c.trim()).filter(Boolean);
        for(let i=0;i<x.length;i++) {
          let vals = z.map(row=>row[i]);
          let boxColor = userBoxColors[i] || couleurs[i % couleurs.length] || cmin;
          data.push({
            y: vals,
            name: customNames[i] || x[i],
            type: "box",
            marker:{color: boxColor},
            boxmean: true,
            showlegend: showLegend
          });
        }
        layout = {
          margin:{t:45,r:5,l:45,b:30},
          height: figHeight, width: figWidth,
          yaxis:{automargin:true, showgrid: !!showGrid},
          xaxis:{showgrid: !!showGrid},
          showlegend: showLegend
        };
        if (ymin !== "") layout.yaxis.range = [Number(ymin), (ymax!=="")?Number(ymax):undefined];
        if (xmin !== "") { layout.xaxis.range = [isNaN(xmin)?xmin:+xmin, (xmax!=="")?(isNaN(xmax)?xmax:+xmax):undefined]; }
      }
      else if(type==="hist") {
        let all = z.flat();
        data = [{
          x: all, type:'histogram', marker:{color:cmax},
          nbinsx:10,
          name: title || "Histogramme",
          showlegend: showLegend
        }];
        layout = {
          margin:{t:45,r:5,l:45,b:30},
          height: figHeight, width: figWidth,
          yaxis:{automargin:true, showgrid: !!showGrid},
          xaxis:{showgrid: !!showGrid},
          showlegend: showLegend
        };
        if (ymin !== "" || ymax !== "") layout.yaxis.range = [(ymin!=="")?Number(ymin):undefined, (ymax!=="")?Number(ymax):undefined];
        if (xmin !== "" || xmax !== "") layout.xaxis.range = [(xmin!=="")?(isNaN(xmin)?xmin:+xmin):undefined, (xmax!=="")?(isNaN(xmax)?xmax:+xmax):undefined];
      }
      layout.title = {
        text: title || "Graphique",
        font: {size:titleSize, family:titleFont, color: titleColor}
      };
      layout.legend = layout.legend || {};
      if (legendTitle) {
        layout.legend.title = { text: legendTitle };
      }
      layout.yaxis = layout.yaxis || {};
      layout.xaxis = layout.xaxis || {};
      layout.yaxis.title = {text: yaxis || 'Y', font: {size:yFontSize, color:yColor, family:yFont}};
      layout.yaxis.tickfont = {size:yFontSize, color:yColor, family:yFont};
      layout.xaxis.title = {text: xaxis || 'X', font: {size:xFontSize, color:xColor, family:xFont}};
      layout.xaxis.tickfont = {size:xFontSize, color:xColor, family:xFont};
      if (invertY) layout.yaxis.autorange = 'reversed';
      Plotly.newPlot(plotDiv, data, layout, {responsive:true});
      document.getElementById('btn-download').style.display = '';
      return false;
    }
    function savePlot() {
      Plotly.downloadImage('dataviz-plot', {format:"png", filename:"dataviz"});
    }
    window.openToolsViz = function() { document.getElementById('tools-viz-modal').style.display="flex"; }
    window.closeToolsViz = function() { document.getElementById('tools-viz-modal').style.display="none"; }
    // Initial dump (pour affichage initial des champs dynamiques au rechargement/1ère ouverture)
    if(typeof window !== "undefined") {
      setTimeout(function(){
        updateLegendNamesInputs();
        showBoxColorsIfNeeded();
      }, 160);
    }
    </script>
  </main>
  <script>
    // Bg animé repris de management
  const SYMBOLS = ["⚙","🔧"];
  const COLORS = ["#11bba4","#0fc1c7","#127782","#0cceea","#11bba8"];
  function resizeBgManagement() {
    const c = document.getElementById('bg-management');
    if (!c) return;
    c.width = window.innerWidth;
    c.height = window.innerHeight;
  }
  resizeBgManagement();
  window.addEventListener('resize', resizeBgManagement);
  const NB_OBJ = 10;
  const symbols = [];
  for(let i=0;i<NB_OBJ;i++) {
    const si = Math.floor(Math.random()*SYMBOLS.length);
    symbols.push({
      x: Math.random()*window.innerWidth,
      y: Math.random()*window.innerHeight,
      size: 32 + Math.random()*25,
      symbol: SYMBOLS[si],
      color: COLORS[si % COLORS.length],
      dx: (Math.random()-0.5)*0.15,
      dy: (Math.random()-0.5)*0.15,
      rot: (Math.random()-0.5)*0.007,
      angle: Math.random()*2*Math.PI,
      opacity: 0.14 + Math.random()*0.17
    });
  }
  function animateBgManagement(time=0){
    const c = document.getElementById('bg-management');
    if(!c) return;
    const ctx = c.getContext('2d');
    const w = c.width, h = c.height;
    ctx.clearRect(0,0,w,h);
    for(let obj of symbols){
      obj.x += obj.dx; obj.y += obj.dy;
      obj.angle += obj.rot;
      if(obj.x < -50 || obj.x > w+50) obj.dx *= -1;
      if(obj.y < -50 || obj.y > h+50) obj.dy *= -1;
      ctx.save();
      ctx.translate(obj.x, obj.y);
      ctx.rotate(obj.angle);
      ctx.globalAlpha = obj.opacity;
      ctx.font = `${obj.size}px Arial`;
      ctx.fillStyle = obj.color;
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";
      ctx.fillText(obj.symbol, 0, 0);
      ctx.restore();
    }
    requestAnimationFrame(animateBgManagement);
  }
  animateBgManagement();
  // Pour le bouton retour en haut
  window.addEventListener('scroll', function() {
    const topBtn = document.getElementById('top-btn');
    if(topBtn) topBtn.style.display = (window.scrollY > 250) ? 'block' : 'none';
  });

  //fin
  document.getElementById('btnShowViz').addEventListener('click', function(e){
    e.preventDefault();
    document.getElementById('tools-viz-modal').style.display = '';
  });
  function closeToolsViz(){ document.getElementById('tools-viz-modal').style.display = "none"; }
  function loadCSV(input) {
    if (!input.files[0]) return;
    const reader = new FileReader();
    reader.onload = e => {
      let txt = e.target.result;
      // Remplace , ; tabulation par des espaces pour un parsing robuste
      txt = txt.replace(/[,;\t]/g,' ');
      document.getElementById('datamatrix').value = txt;
    };
    reader.readAsText(input.files[0]);
  }

  // JS pour la fenetre modal clustering
  function openGeneClusterModal() {
    document.getElementById('geneClusterModal').style.display = 'block';
  }

  function closeGeneClusterModal() {
    document.getElementById('geneClusterModal').style.display = 'none';
  }
  // JS pour la fenetre modal diagramme interactif
  function opendiagrammeModal() {
    document.getElementById('diagrammeModal').style.display = 'block';
  }

  function closediagrammeModal() {
    document.getElementById('diagrammeModal').style.display = 'none';
  }
  // JS pour la fenetre modal parseur csv
  function openparseurModal() {
    document.getElementById('parseurModal').style.display = 'block';
  }

  function closeparseurModal() {
    document.getElementById('parseurModal').style.display = 'none';
  }


  // Permet de fermer la modale si clic à l'extérieur
  window.onclick = function(event) {
    var modal = document.getElementById('geneClusterModal');
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }
  </script>
  <a href="#" class="scrolltop-btn" id="top-btn"
  onclick="window.scrollTo({top:0, behavior:'smooth'}); return false;">
  ↑ Retour en haut
</a>
</body>
</html>
